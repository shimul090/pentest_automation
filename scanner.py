import os
from fpdf import FPDF
import nmap
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
print("Scanning may take too long time. First, provided address will be scanned using nmap.")
web_url = input('Enter the URL to scan: ')
nm = nmap.PortScanner()
nm.scan(web_url)


pdf = FPDF()
pdf.add_page()
pdf.set_font("Arial", size = 15)
pdf.cell(200, 10, txt = "Penetration Testing report generated from nmap", ln = 1, align = 'C')
pdf.set_font("Arial", size = 12)

for host in nm.all_hosts():
    if nm[host].hostname() == '':
        hostname = "Couldn't get the hostname"
    else:
        hostname = nm[host].hostname()
    pdf.cell(200, 10, txt="Hostname: " + host + '(' + hostname + ')', ln=1, align='L')
    pdf.cell(200, 10, txt="State: " + nm[host].state(), ln=1, align='L')
    for proto in nm[host].all_protocols():
        pdf.cell(200, 10, txt="----------", ln=1, align='L')
        pdf.cell(200, 10, txt="Protocol: " + proto, ln=1, align='L')
        lport = nm[host][proto].keys()
        for port in lport:
            pdf.cell(200, 10, txt="Port: " + str(port) + ', State: ' + nm[host][proto][port]['state'] , ln=1, align='L')
print("Scanning using nmap is finised. Now it will be scanned using nikto. Again scanning with nikto can take up to 45 minutes depending on the web server traffic.")
pdf.set_font("Arial", size = 15)
pdf.cell(200, 10, txt = "Penetration Testing report generated from nikto", ln = 1, align = 'C')
pdf.set_font("Arial", size = 12)
print(os.system('nikto -h ' + web_url + ' -ssl -output /home/shimul/Documents/pentest/nikto_result.txt'))
file = open('/home/shimul/Documents/pentest/nikto_result.txt', mode='r')
for line in file.readlines():
    pdf.cell(200, 10, txt=line, ln=1, align='L')
file.close()

pdf.cell(200, 10, txt = "Disclaimer: This is a system generated report.", ln = 1, align = 'C')
pdf.output("/home/shimul/Documents/pentest/report.pdf")
print("Report Generation finished")
print("Please provide the mail address you want this report to be sent.")


fromaddr = "Shimul Debnath <shimul.debnath917@gmail.com>"
toaddr = input("Mail address: ")

msg = MIMEMultipart()
msg['From'] = fromaddr

msg['To'] = toaddr

msg['Subject'] = "System generated pentesting report"

body = "This report is auto generated. Tools used: nmap."

msg.attach(MIMEText(body, 'plain'))

filename = "report.pdf"
attachment = open("/home/shimul/Documents/pentest/report.pdf", "rb")

p = MIMEBase('application', 'octet-stream')

p.set_payload((attachment).read())

encoders.encode_base64(p)

p.add_header('Content-Disposition', "attachment; filename= %s" % filename)

msg.attach(p)

server = smtplib.SMTP('smtp.gmail.com', 587)
message = """From: Shimul Debnath <shimul.debnath917@gmail.com>
To: To Person <shimuldebnath090@gmail.com>
MIME-Version: 1.0
Content-type: text/html
Subject: Sending email using Python smtplib library

<b>So, verily, with every difficulty, there is relief, Verily, with every difficulty, there is relief</b>
"""
server.starttls()
server.login('shimul.debnath917@gmail.com', '16 digit code')
text = msg.as_string()
server.sendmail('shimul.debnath917@gmail.com', toaddr, text)
print('Mail Sent')